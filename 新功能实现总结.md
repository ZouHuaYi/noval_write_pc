# æ–°åŠŸèƒ½å®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. ğŸ§ª semanticSimilar çš„å¯è½åœ°å®ç°

**æ–‡ä»¶**: `electron/memory/finalizer/semanticSimilarity.js`

**åŠŸèƒ½**:
- ä½¿ç”¨ embedding API è·å–æ–‡æœ¬å‘é‡
- è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦åˆ¤æ–­è¯­ä¹‰ç›¸ä¼¼æ€§
- æ”¯æŒç¼“å­˜æœºåˆ¶ï¼Œé¿å…é‡å¤è®¡ç®—
- å¯é…ç½®ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆé»˜è®¤ 0.75ï¼‰

**é›†æˆ**:
- `ConceptResolver` å·²é›†æˆè¯­ä¹‰ç›¸ä¼¼åº¦åˆ¤æ–­
- åœ¨ `resolveConcept` æ–¹æ³•ä¸­è‡ªåŠ¨ä½¿ç”¨ï¼ˆå¦‚æœé…ç½®äº† LLMï¼‰
- ç²¾ç¡®åŒ¹é…å¤±è´¥åè‡ªåŠ¨å°è¯•è¯­ä¹‰åŒ¹é…

**ä½¿ç”¨ç¤ºä¾‹**:
```javascript
const resolver = new ConceptResolver(workspaceRoot);
resolver.setLLMConfig({
  baseUrl: 'https://api.openai.com/v1',
  apiKey: 'your-api-key',
  embeddingModel: 'text-embedding-ada-002'
});

// è‡ªåŠ¨ä½¿ç”¨è¯­ä¹‰ç›¸ä¼¼åº¦
const result = await resolver.resolveConcept('åœ°ç£å¼‚å¸¸');
// å¦‚æœå·²æœ‰æ¦‚å¿µ 'ç£åœºåç§»'ï¼Œä¼šè¢«è‡ªåŠ¨åŒ¹é…
```

**ç‰¹æ€§**:
- âœ… ç¼“å­˜æœºåˆ¶ï¼šç›¸åŒæ–‡æœ¬çš„ embedding ä¼šè¢«ç¼“å­˜
- âœ… é™çº§ç­–ç•¥ï¼šå¦‚æœ embedding å¤±è´¥ï¼Œå›é€€åˆ°ç²¾ç¡®åŒ¹é…
- âœ… æ‰¹é‡åŒ¹é…ï¼šæ”¯æŒåœ¨å¤šä¸ªå€™é€‰æ¦‚å¿µä¸­æŸ¥æ‰¾æœ€ç›¸ä¼¼çš„

---

### 2. ğŸ“Š ä¼ç¬”å›æ”¶é¢æ¿æ•°æ®æ¥å£

**æ–‡ä»¶**: `electron/memory/finalizer/foreshadowPanel.js`

**åŠŸèƒ½**:
- æŒ‰çŠ¶æ€åˆ†ç»„ä¼ç¬”ï¼ˆpending, confirmed, revealed, archivedï¼‰
- è·å–ä¼ç¬”ç»Ÿè®¡ä¿¡æ¯
- è¯†åˆ«å¾…å›æ”¶ä¼ç¬”ï¼ˆè¶…è¿‡é˜ˆå€¼ç« èŠ‚æ•°æœªæ›´æ–°ï¼‰
- æä¾›å›æ”¶å»ºè®®
- æœç´¢ä¼ç¬”åŠŸèƒ½
- è·å–ä¼ç¬”æ—¶é—´çº¿

**API æ¥å£**:
```javascript
// è·å–é¢æ¿æ•°æ®
memory.getForeshadowPanelData(currentChapter)

// è¿”å›æ•°æ®ç»“æ„:
{
  statistics: {
    total: 10,
    pending: 3,
    confirmed: 2,
    revealed: 4,
    archived: 1,
    active: 5,      // pending + confirmed
    resolved: 5     // revealed + archived
  },
  byState: {
    pending: [...],
    confirmed: [...],
    revealed: [...],
    archived: [...]
  },
  timeline: [...],  // æŒ‰ç« èŠ‚æ’åº
  openMysteries: [...],  // æœªè§£ä¹‹è°œ
  pendingRecycle: [...]  // å¾…å›æ”¶ä¼ç¬”ï¼ˆå¦‚æœæä¾›äº† currentChapterï¼‰
}
```

**IPC æ¥å£**:
- `memory:getForeshadowPanelData` - è·å–é¢æ¿æ•°æ®
- `memory:searchForeshadows` - æœç´¢ä¼ç¬”

**ç‰¹æ€§**:
- âœ… è‡ªåŠ¨è¯†åˆ«é•¿æ—¶é—´æœªæ›´æ–°çš„ä¼ç¬”
- âœ… æä¾›å›æ”¶å»ºè®®ï¼ˆåŸºäºç« èŠ‚æ•°ï¼‰
- âœ… æ”¯æŒæŒ‰æ¦‚å¿µåç§°ã€åˆ«åã€æè¿°æœç´¢

---

### 3. ğŸ”¥ äººç‰©çŠ¶æ€çš„çŸ¥è¯†åŒ–ç‰ˆæœ¬

**æ–‡ä»¶**: `electron/memory/finalizer/characterStateKnowledge.js`

**æ•°æ®æ–‡ä»¶**: `electron/memory/core/character_states.json`

**åŠŸèƒ½**:
- åªè®°å½•ä¸å¯é€†çš„çŠ¶æ€å˜åŒ–ï¼ˆæ›¿ä»£ state_historyï¼‰
- æ”¯æŒçš„çŠ¶æ€ç±»å‹ï¼š
  - `level_breakthrough` - å¢ƒç•Œçªç ´
  - `death` - æ­»äº¡
  - `awakening` - è§‰é†’
  - `irreversible_change` - å…¶ä»–ä¸å¯é€†å˜åŒ–
- è‡ªåŠ¨å…³è”æ¦‚å¿µå¼•ç”¨ï¼ˆå¦‚å¢ƒç•Œæ¦‚å¿µï¼‰
- æä¾›çŠ¶æ€æŸ¥è¯¢å’Œç»Ÿè®¡

**æ•°æ®ç»“æ„**:
```json
{
  "state_id": "state_xxx",
  "character_name": "å¼ æ˜",
  "type": "level_breakthrough",
  "state_change": {
    "level": "ç­‘åŸºåˆæœŸ"
  },
  "chapter": 10,
  "concept_refs": ["concept_cultivation_level"],
  "recorded_at": "2024-01-01T00:00:00.000Z"
}
```

**API æ¥å£**:
```javascript
// è®°å½•çŠ¶æ€å˜åŒ–
characterStateKnowledge.recordStateChange(
  'å¼ æ˜', 
  { level: 'ç­‘åŸºåˆæœŸ' },
  10,
  'level_breakthrough'
);

// è·å–è§’è‰²çŠ¶æ€
characterStateKnowledge.getCharacterStates('å¼ æ˜');
characterStateKnowledge.getCharacterCurrentState('å¼ æ˜');

// è·å–ç»Ÿè®¡
characterStateKnowledge.getStatisticsByType();
```

**IPC æ¥å£**:
- `memory:getAllCharacterStates` - è·å–æ‰€æœ‰è§’è‰²çŠ¶æ€æ‘˜è¦
- `memory:getCharacterStates` - è·å–ç‰¹å®šè§’è‰²çš„çŠ¶æ€
- `memory:getCharacterStateStatistics` - è·å–çŠ¶æ€ç»Ÿè®¡

**ç‰¹æ€§**:
- âœ… åªè®°å½•ä¸å¯é€†äº‹å®ï¼Œä¸è®°å½•ä¸´æ—¶çŠ¶æ€
- âœ… è‡ªåŠ¨å»é‡ï¼ˆç›¸åŒçŠ¶æ€ä¸ä¼šé‡å¤è®°å½•ï¼‰
- âœ… æ”¯æŒæ¦‚å¿µå¼•ç”¨ï¼ˆå¢ƒç•Œç­‰å¯ä»¥å…³è”åˆ°æ¦‚å¿µï¼‰
- âœ… æä¾›æ­»äº¡æ£€æŸ¥ã€æœ€é«˜å¢ƒç•ŒæŸ¥è¯¢ç­‰ä¾¿æ·æ–¹æ³•

**é›†æˆåˆ° ChapterFinalizer**:
- åœ¨ç« èŠ‚ç»“ç®—æ—¶è‡ªåŠ¨å¤„ç† `character_states` å­—æ®µ
- ä» ChapterExtract ä¸­æå–äººç‰©çŠ¶æ€å¹¶è®°å½•

---

## ğŸ“ ChapterExtract æ‰©å±•

ä¸ºäº†æ”¯æŒäººç‰©çŠ¶æ€ï¼ŒChapterExtract ç»“æ„å¯ä»¥åŒ…å«ï¼š

```json
{
  "chapter": 10,
  "fact_candidates": [...],
  "concept_mentions": [...],
  "foreshadow_candidates": [...],
  "character_states": [
    {
      "character_name": "å¼ æ˜",
      "state_change": {
        "level": "ç­‘åŸºåˆæœŸ"
      },
      "chapter": 10,
      "type": "level_breakthrough"
    }
  ],
  "story_state_snapshot": {...}
}
```

---

## ğŸ”§ é…ç½®è¦æ±‚

### è¯­ä¹‰ç›¸ä¼¼åº¦åŠŸèƒ½

éœ€è¦åœ¨ LLM é…ç½®ä¸­åŒ…å« embedding æ¨¡å‹ï¼š

```javascript
{
  baseUrl: 'https://api.openai.com/v1',
  apiKey: 'your-api-key',
  embeddingModel: 'text-embedding-ada-002'  // å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨æ­¤å€¼
}
```

MemoryManager ä¼šè‡ªåŠ¨å°† LLM é…ç½®ä¼ é€’ç»™ ChapterFinalizerã€‚

---

## ğŸ¯ ä½¿ç”¨æµç¨‹

### 1. è¯­ä¹‰ç›¸ä¼¼åº¦
1. é…ç½® LLMï¼ˆåŒ…å« embedding æ¨¡å‹ï¼‰
2. MemoryManager åˆå§‹åŒ–æ—¶è‡ªåŠ¨è®¾ç½®
3. ç« èŠ‚ç»“ç®—æ—¶è‡ªåŠ¨ä½¿ç”¨è¯­ä¹‰ç›¸ä¼¼åº¦åŒ¹é…æ¦‚å¿µ

### 2. ä¼ç¬”å›æ”¶é¢æ¿
1. è°ƒç”¨ `memory.getForeshadowPanelData(currentChapter)`
2. è·å–ç»Ÿè®¡ã€åˆ†ç»„ã€æ—¶é—´çº¿ç­‰æ•°æ®
3. ä½¿ç”¨ `pendingRecycle` è·å–å¾…å›æ”¶å»ºè®®

### 3. äººç‰©çŠ¶æ€çŸ¥è¯†åŒ–
1. Agent åœ¨ ChapterExtract ä¸­åŒ…å« `character_states`
2. ç« èŠ‚ç»“ç®—æ—¶è‡ªåŠ¨è®°å½•åˆ° `character_states.json`
3. é€šè¿‡ API æŸ¥è¯¢è§’è‰²çŠ¶æ€å†å²

---

## ğŸ“Š æ•°æ®æµå‘

```
Agent â†’ ChapterExtract
         â†“
   ChapterFinalizer
         â†“
   â”œâ”€ ConceptResolver (è¯­ä¹‰ç›¸ä¼¼åº¦åŒ¹é…)
   â”œâ”€ Facts (äº‹å®å±‚)
   â”œâ”€ Foreshadows (ä¼ç¬”çŠ¶æ€æœº)
   â”œâ”€ CharacterStates (äººç‰©çŠ¶æ€çŸ¥è¯†åŒ–)
   â””â”€ StoryState (æ•…äº‹çŠ¶æ€)
```

---

## ğŸš€ ä¸‹ä¸€æ­¥ä¼˜åŒ–

1. **è¯­ä¹‰ç›¸ä¼¼åº¦ä¼˜åŒ–**
   - æ”¯æŒæ‰¹é‡ embedding è¯·æ±‚ï¼ˆå‡å°‘ API è°ƒç”¨ï¼‰
   - æ·»åŠ ç›¸ä¼¼åº¦é˜ˆå€¼é…ç½®ç•Œé¢
   - æ”¯æŒæœ¬åœ° embedding æ¨¡å‹

2. **ä¼ç¬”å›æ”¶é¢æ¿ UI**
   - åˆ›å»ºä¸“é—¨çš„ä¼ç¬”ç®¡ç†ç•Œé¢
   - å¯è§†åŒ–ä¼ç¬”æ—¶é—´çº¿
   - ä¸€é”®å›æ”¶åŠŸèƒ½

3. **äººç‰©çŠ¶æ€å¢å¼º**
   - æ”¯æŒçŠ¶æ€å˜åŒ–å†²çªæ£€æµ‹
   - æ·»åŠ çŠ¶æ€å˜åŒ–å½±å“åˆ†æ
   - æ”¯æŒçŠ¶æ€å›æ»šï¼ˆç‰¹æ®Šæƒ…å†µï¼‰

---

## âœ… æµ‹è¯•å»ºè®®

1. **è¯­ä¹‰ç›¸ä¼¼åº¦æµ‹è¯•**
   - åˆ›å»ºåŒ…å«ç›¸ä¼¼æ¦‚å¿µçš„ä¸åŒè¡¨è¿°çš„ç« èŠ‚
   - éªŒè¯æ˜¯å¦èƒ½æ­£ç¡®å½’ä¸€åˆ°åŒä¸€æ¦‚å¿µ
   - æ£€æŸ¥ç›¸ä¼¼åº¦åˆ†æ•°æ˜¯å¦åˆç†

2. **ä¼ç¬”å›æ”¶æµ‹è¯•**
   - åˆ›å»ºå¤šä¸ªçŠ¶æ€çš„ä¼ç¬”
   - éªŒè¯ç»Ÿè®¡ä¿¡æ¯æ˜¯å¦æ­£ç¡®
   - æµ‹è¯•å¾…å›æ”¶è¯†åˆ«åŠŸèƒ½

3. **äººç‰©çŠ¶æ€æµ‹è¯•**
   - è®°å½•å¤šä¸ªè§’è‰²çš„çŠ¶æ€å˜åŒ–
   - éªŒè¯å»é‡åŠŸèƒ½
   - æµ‹è¯•çŠ¶æ€æŸ¥è¯¢å’Œç»Ÿè®¡

