å¾ˆå¥½ï¼Œè¿™ä¸€æ­¥**æ˜¯ä½ è¿™ä¸ªå°è¯´ IDE ä»â€œèƒ½è·‘â€å‡çº§åˆ°â€œèƒ½æ´»â€çš„åˆ†æ°´å²­**ã€‚
æˆ‘ç»™ä½ ä¸€å¥—**å¯ä»¥ç›´æ¥è½åœ°çš„ã€ŒçŸ¥è¯†å‹è®°å¿†ç³»ç»Ÿã€è®¾è®¡**ï¼Œä¸æ˜¯è®ºæ–‡ï¼Œä¸æ˜¯ç©ºæ¦‚å¿µï¼Œè€Œæ˜¯ï¼š

> **æ˜ç¡®åˆ†å±‚ + æ˜ç¡®èº«ä»½ + æ˜ç¡® CRUD è¯­ä¹‰ + æ˜ç¡®ç« ç»“ç®—æµç¨‹**

ä¸‹é¢æˆ‘ä¼šæŒ‰ **ã€Œè®¾è®¡åŸåˆ™ â†’ æ¶æ„ â†’ æ•°æ®æ¨¡å‹ â†’ CRUD è§„åˆ™ â†’ å†™å…¥æµç¨‹ã€** æ¥ã€‚

---

# ä¸€ã€æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼ˆè¯·å…ˆçœ‹ï¼‰

### ä½ è¦ä»è¿™ 4 ä¸ªâ€œé”™è§‰â€ä¸­è·³å‡ºæ¥

| æ—§é”™è§‰           | æ–°ç°å®              |
| ------------- | ---------------- |
| AI æ¯æ¬¡è¯´çš„è¯éƒ½æ˜¯æ–°ä¿¡æ¯ | **90% æ˜¯ç¡®è®¤ / é‡è¿°** |
| è®°å¿† = æ—¥å¿—       | **è®°å¿† = ç¨³å®šäº‹å®**    |
| å¤šå­˜ç‚¹æ²¡äº‹         | **é‡å¤ = æ¯’è¯**      |
| Agent è‡ªç”±å†™è®°å¿†   | **è®°å¿†å†™å…¥æ˜¯å—æ§äº‹åŠ¡**    |

---

# äºŒã€æ•´ä½“æ¶æ„ï¼ˆçŸ¥è¯†æ€ç»´ä¸‰å±‚æ¨¡å‹ï¼‰

> **ä¸€å¥è¯ï¼šåªæœ‰â€œäº‹å®â€æ‰æ˜¯è®°å¿†ï¼Œå…¶å®ƒéƒ½æ˜¯ä¸­é—´æ€**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ§  KNOWLEDGE CORE       â”‚  â† å¯é•¿æœŸå­˜åœ¨
â”‚                          â”‚
â”‚  â‘  Fact Layer            â”‚  ï¼ˆä¸å¯éšæ„æ”¹ï¼‰
â”‚  â‘¡ Canonical Concepts    â”‚
â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ“˜ NARRATIVE STATE      â”‚  â† å½“å‰æ•…äº‹çŠ¶æ€
â”‚                          â”‚
â”‚  â‘¢ Story State           â”‚
â”‚  â‘£ Foreshadow State      â”‚
â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ§ª DERIVED / CACHE      â”‚  â† å¯éšæ—¶ä¸¢å¼ƒ
â”‚                          â”‚
â”‚  â‘¤ Chapter Extracts      â”‚
â”‚  â‘¥ Agent Reasoning Cache â”‚
â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ä¸‰ã€å„å±‚è¯´æ˜ï¼ˆè¿™æ˜¯æ ¸å¿ƒï¼‰

---

## â‘  Fact Layerï¼ˆäº‹å®å±‚ï¼‰ã€æœ€å°ã€æœ€å¹²å‡€ã€‘

**å®šä¹‰ï¼š**

> ä¸€æ—¦å†™å…¥ï¼Œå°±ä»£è¡¨â€œå°è¯´ä¸–ç•Œå®¢è§‚æˆç«‹â€

### åªå…è®¸å­˜ï¼š

* ä¸–ç•Œè§„åˆ™ï¼ˆç‰©ç† / è¶…è‡ªç„¶ï¼‰
* ç”Ÿç‰©å­¦äº‹å®
* äººç‰©ä¸å¯é€†äº‹ä»¶ï¼ˆæ­»äº¡ / è§‰é†’ï¼‰
* åœ°ç‚¹çš„å®¢è§‚å±æ€§

### ç¤ºä¾‹

```json
{
  "fact_id": "fact_geomagnetic_shield_weakening",
  "type": "world_rule",
  "statement": "åœ°çƒç£åœºæ­£åœ¨æŒç»­å‡å¼±ï¼Œå¯¼è‡´å®‡å®™è¾å°„é˜²æŠ¤ä¸‹é™",
  "introduced_in": 21,
  "confidence": "canonical"
}
```

### è§„åˆ™

* âŒ ä¸å­˜â€œAI æ¨æµ‹â€
* âŒ ä¸å­˜â€œå¯èƒ½â€
* âŒ ä¸å­˜â€œæè¿°æ€§ä¿®è¾â€

---

## â‘¡ Canonical Conceptsï¼ˆæ¦‚å¿µå±‚ï¼‰

> **è§£å†³â€œåŒä¸€è¯­ä¹‰å¤šæ¬¡å‡ºç°â€çš„å…³é”®å±‚**

### å®ƒçš„ä½œç”¨ï¼š

* ç»™â€œç£åœºåç§» / ä¿æŠ¤å±‚å‡å¼±â€ä¸€ä¸ª**ç»Ÿä¸€èº«ä»½**
* åç»­æ‰€æœ‰æåŠéƒ½â€œæŒ‚é â€åœ¨å®ƒä¸‹é¢

### ç¤ºä¾‹

```json
{
  "concept_id": "concept_geomagnetic_anomaly",
  "aliases": [
    "åœ°ç£å¼‚å¸¸",
    "ç£åœºåç§»",
    "ä¿æŠ¤å±‚å‡å¼±"
  ],
  "description": "åœ°çƒç£åœºå‡ºç°å¼‚å¸¸å˜åŒ–ï¼Œå¼•å‘ä¸€ç³»åˆ—ç¾éš¾æ€§åæœ"
}
```

ğŸ“Œ **åæœï¼š**

* ä¸ç®¡ AI ç”¨ä»€ä¹ˆè¯
* å­˜å‚¨å±‚åªæœ‰ **ä¸€ä¸ªæ¦‚å¿µ**

---

## â‘¢ Story Stateï¼ˆå™äº‹çŠ¶æ€ï¼‰

> â€œç°åœ¨å‰§æƒ…è¿›è¡Œåˆ°å“ªä¸€æ­¥äº†ï¼Ÿâ€

### ç¤ºä¾‹

```json
{
  "chapter": 22,
  "current_location": "æ¾æ—é•‡",
  "global_tension": "high",
  "known_threats": ["concept_mutated_entities"],
  "open_mysteries": ["concept_unknown_watchers"]
}
```

* æ¯ç« åªå…è®¸ **1 æ¬¡è¦†ç›–å¼å†™å…¥**
* æ°¸è¿œåªæœ‰ **æœ€æ–°çŠ¶æ€**

---

## â‘£ Foreshadow Stateï¼ˆä¼ç¬”çŠ¶æ€æœºï¼‰

> ä¼ç¬”ä¸æ˜¯äº‹å®ï¼Œæ˜¯ã€Œæœªæ¥æ‰¿è¯ºã€

### å”¯ä¸€èº«ä»½ = concept_id

```json
{
  "concept_id": "concept_unknown_watchers",
  "state": "pending",
  "introduced_in": 22,
  "last_touched": 22
}
```

### çŠ¶æ€æœºï¼ˆå¼ºåˆ¶ï¼‰

```
pending â†’ confirmed â†’ revealed â†’ archived
```

* ä¸å…è®¸å›é€€
* ä¸å…è®¸ duplicate
* â€œæ­ç¤ºâ€ = çŠ¶æ€è¿ç§»ï¼Œä¸æ˜¯æ–°æ¡ç›®

---

## â‘¤ Chapter Extractsï¼ˆç« èŠ‚æå–ç‰©ï¼‰ã€ä¸€æ¬¡æ€§ã€‘

```json
{
  "chapter": 22,
  "extracted_facts": [...],
  "extracted_concepts": [...],
  "raw_notes": "..."
}
```

* ä»…ç”¨äºï¼š

  * merge åˆ¤æ–­
  * äººç±»è°ƒè¯•
* å¯éšæ—¶åˆ é™¤

---

## â‘¥ Agent Reasoning Cacheï¼ˆå½»åº•ä¸æŒä¹…ï¼‰

* Chain-of-thought
* ä¸­é—´åˆ¤æ–­
* Prompt ä¸´æ—¶ç»“æ„

ğŸš« **ä¸¥ç¦å†™å…¥é•¿æœŸè®°å¿†**

---

# å››ã€CRUD è¯­ä¹‰ï¼ˆéå¸¸é‡è¦ï¼‰

## Createï¼ˆåˆ›å»ºï¼‰

> **åªåœ¨â€œä»æ— åˆ°æœ‰â€æ—¶å…è®¸**

* æ–°æ¦‚å¿µ
* æ–°äº‹å®
* æ–°ä¼ç¬”ï¼ˆconcept_id ä¸å­˜åœ¨ï¼‰

---

## Readï¼ˆè¯»å–ï¼‰

> **æ°¸è¿œåªè¯» Fact + Concept + State**

Agent ç¦æ­¢ç›´æ¥è¯»ï¼š

* å†å²æ—¥å¿—
* ä¸­é—´æå–

---

## Updateï¼ˆæ›´æ–°ï¼‰

| å¯¹è±¡          | Update æ–¹å¼             |
| ----------- | --------------------- |
| Fact        | âŒ ä¸å¯æ›´æ–°                |
| Concept     | ä»… alias / description |
| Story State | æ•´ç« è¦†ç›–                  |
| Foreshadow  | çŠ¶æ€è¿ç§»                  |

---

## Deleteï¼ˆåˆ é™¤ï¼‰

> åªå…è®¸åˆ é™¤ï¼š

* Extracts
* Cache

**äº‹å®æ°¸ä¸åˆ é™¤**

---

# äº”ã€ç« èŠ‚ç»“ç®—æµç¨‹ï¼ˆä½ ç°åœ¨æœ€ç¼ºçš„ï¼‰

> **æ¯ç« ç»“æŸï¼Œç»Ÿä¸€ç»“ç®—**

```
â‘  Agent é˜…è¯»ç« èŠ‚
â‘¡ è¾“å‡º Chapter Extractï¼ˆä¸´æ—¶ï¼‰
â‘¢ ç³»ç»Ÿæ‰§è¡Œ merge
   - æ˜¯å¦å·²æœ‰ conceptï¼Ÿ
   - æ˜¯å¦ä¸ºæ–° factï¼Ÿ
   - æ˜¯å¦ä¼ç¬”çŠ¶æ€å˜åŒ–ï¼Ÿ
â‘£ æ›´æ–°ï¼š
   - Concept registry
   - Fact layerï¼ˆå¦‚ç¡®è®¤ï¼‰
   - Foreshadow state
   - Story stateï¼ˆè¦†ç›–ï¼‰
â‘¤ åˆ é™¤ Chapter Extract
```

ğŸ“Œ **ä»»ä½• Agent ä¸å…è®¸ç›´æ¥å†™é•¿æœŸè®°å¿†**

---

# å…­ã€ä½ ç°åœ¨ç«‹åˆ»è¯¥åšçš„ 3 ä»¶äº‹ï¼ˆæ­¢è¡€ï¼‰

1ï¸âƒ£ **å†»ç»“ç°æœ‰ memory å†™å…¥**
2ï¸âƒ£ **å®ç° concept registryï¼ˆå“ªæ€•æ˜¯ jsonï¼‰**
3ï¸âƒ£ **æ‰€æœ‰â€œæ–°è®°å¿†â€å…ˆå†™ extract**

---

# ä¸ƒã€ä½ ç°åœ¨è¿™å¥— IDEï¼Œå·²ç»å…·å¤‡ä»€ä¹ˆç¨‹åº¦ï¼Ÿ

æˆ‘å¯ä»¥å¾ˆæ˜ç¡®å‘Šè¯‰ä½ ï¼š

> **ä½ ç°åœ¨å·²ç»åœ¨åšã€ŒAI Authoring Toolã€è€Œä¸æ˜¯â€œå†™ä½œåŠ©æ‰‹â€**

å¥½ï¼Œè¿™é‡Œæˆ‘**ä¸å†è®²æ¦‚å¿µ**ï¼Œç›´æ¥è¿›å…¥**ã€Œä¸‹ä¸€æ­¥ï¼å¯æ‰§è¡Œæ–¹æ¡ˆã€**ã€‚
ç›®æ ‡åªæœ‰ä¸€ä¸ªï¼š

> **è®©ä½ çš„ç³»ç»Ÿä»Šå¤©å¼€å§‹â€œæ­¢è¡€â€ï¼Œä¸‹å‘¨å¼€å§‹â€œè¿›åŒ–â€**

---

# âœ… ä¸‹ä¸€æ­¥ï¼šå®ç°ã€Œç« èŠ‚ç»“ç®—å™¨ + è¯­ä¹‰åˆå¹¶å¼•æ“ã€

è¿™æ˜¯**å”¯ä¸€æ­£ç¡®çš„ä¸‹ä¸€æ­¥**ï¼Œé¡ºåºä¸èƒ½åã€‚

---

## ä¸€ã€ä½ ç°åœ¨è¦åšçš„ä¸æ˜¯â€œé‡æ„å…¨éƒ¨â€ï¼Œè€Œæ˜¯åŠ ä¸€ä¸ªã€Œé—¸é—¨ã€

### âŒ å½“å‰ï¼ˆå±é™©ï¼‰

```
Agent â†’ ç›´æ¥å†™ character / plot / foreshadow / world_rules
```

### âœ… ä¸‹ä¸€æ­¥ï¼ˆæ­£ç¡®ï¼‰

```
Agent â†’ ChapterExtractï¼ˆä¸´æ—¶ï¼‰
        â†“
   ChapterFinalizerï¼ˆä½ å†™çš„ï¼‰
        â†“
   Knowledge Coreï¼ˆå—æ§å†™å…¥ï¼‰
```

ğŸ‘‰ **æ‰€æœ‰ Agent å¤±å»â€œå†™é•¿æœŸè®°å¿†â€çš„æƒé™**

---

## äºŒã€ç¬¬ä¸€ä»¶å¿…é¡»é©¬ä¸Šåšçš„äº‹ï¼ˆä»Šå¤©å°±èƒ½å¹²ï¼‰

### ğŸ”’ å†»ç»“é•¿æœŸè®°å¿†å†™å…¥

åªå…è®¸å†™ä¸€ä¸ªæ–‡ä»¶ï¼ˆæˆ–å¯¹è±¡ï¼‰ï¼š

```
/memory/_extracts/chapter_XX.json
```

### ChapterExtract ç»“æ„ï¼ˆæœ€å°ç‰ˆï¼‰

```json
{
  "chapter": 23,
  "facts_candidates": [],
  "concept_mentions": [],
  "foreshadow_candidates": [],
  "state_snapshot": {},
  "raw_text_refs": []
}
```

âš ï¸ æ³¨æ„ï¼š

* è¿™æ˜¯ **å€™é€‰**
* ä¸æ˜¯äº‹å®
* å¯ä»¥éšæ—¶åˆ 

---

## ä¸‰ã€ç¬¬äºŒæ­¥ï¼šå®ç°ã€ŒConcept Registryã€ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰

ä½ ç°åœ¨æ‰€æœ‰çˆ†ç‚¸é—®é¢˜ï¼Œ**90% å› ä¸ºæ²¡æœ‰å®ƒ**ã€‚

### Concept Registry æ˜¯ä»€ä¹ˆï¼Ÿ

> **è¯­ä¹‰èº«ä»½è¯ç³»ç»Ÿ**

### æœ€ç®€å®ç°ï¼ˆJSON å°±å¤Ÿï¼‰

```json
{
  "concept_geomagnetic_anomaly": {
    "aliases": [
      "åœ°ç£å¼‚å¸¸",
      "ç£åœºåç§»",
      "ä¿æŠ¤å±‚å‡å¼±",
      "ç£åœºä¿æŠ¤ç½©å¤±æ•ˆ"
    ],
    "description": "åœ°çƒç£åœºå‡ºç°å¼‚å¸¸å˜åŒ–ï¼Œå¼•å‘ç¾éš¾æ€§åæœ"
  }
}
```

---

### æ‰€æœ‰ merge çš„ç¬¬ä¸€æ­¥éƒ½æ˜¯ï¼š

> **â€œè¿™å¥è¯ï¼ŒæŒ‡çš„æ˜¯ä¸æ˜¯æŸä¸ªå·²æœ‰ conceptï¼Ÿâ€**

---

## å››ã€ç¬¬ä¸‰æ­¥ï¼šç« èŠ‚ç»“ç®—å™¨ï¼ˆChapter Finalizerï¼‰

è¿™æ˜¯ä½  IDE çš„â€œå¿ƒè„â€ã€‚

---

### 1ï¸âƒ£ ç»“ç®—æµç¨‹ï¼ˆå¼ºåˆ¶ï¼‰

```text
è¾“å…¥ï¼šChapterExtract

for æ¯ä¸ª fact_candidate:
  â†’ æ˜¯å¦å·²æœ‰ factï¼Ÿ
    â†’ æ²¡æœ‰ï¼šCreate Fact
    â†’ æœ‰ï¼šä¸¢å¼ƒï¼ˆç¡®è®¤è€Œå·²ï¼‰

for æ¯ä¸ª concept_mention:
  â†’ è¯­ä¹‰å½’ä¸€åŒ– â†’ concept_id
  â†’ è‹¥ä¸å­˜åœ¨ï¼šCreate Concept

for æ¯ä¸ª foreshadow_candidate:
  â†’ å®šä½ concept_id
  â†’ çŠ¶æ€è¿ç§»ï¼ˆä¸æ˜¯æ–°å¢ï¼ï¼‰

StoryStateï¼š
  â†’ æ•´ç« è¦†ç›–å†™å…¥
```

---

### 2ï¸âƒ£ Foreshadow çŠ¶æ€è¿ç§»ï¼ˆå¿…é¡»è¿™æ ·ï¼‰

```js
switch (currentState) {
  case "pending":
    if (confirmed) â†’ confirmed
    break
  case "confirmed":
    if (revealed) â†’ revealed
    break
  case "revealed":
    â†’ archived
}
```

ğŸ“Œ **æ°¸è¿œä¸ create ç¬¬äºŒæ¡**

---

## äº”ã€ä½ ç°åœ¨â€œç«‹åˆ»å¯ä»¥åˆ æ‰â€çš„ä¸œè¥¿

ä¸ºäº†æ­¢è¡€ï¼Œæˆ‘æ˜ç¡®å‘Šè¯‰ä½ ï¼š

### ğŸ—‘ å¯ä»¥ç›´æ¥åºŸå¼ƒ

* character.state_historyï¼ˆæ•´ä½“ï¼‰
* plot.completed_eventsï¼ˆä¿ç•™æ•´ç†åçš„ï¼‰
* world_rules çš„é‡å¤ prompt å†…å®¹
* æ‰€æœ‰ agent ä¸­é—´æ¨ç†å†™å…¥

ğŸ‘‰ **è¿™äº›éƒ½æ˜¯â€œæ—¥å¿—é”™è§‰â€**

---

## å…­ã€ä½ ç°åœ¨ IDE æ¶æ„ä¼šå‘ç”Ÿä»€ä¹ˆå˜åŒ–ï¼Ÿ

### å†™ä½œä½“éªŒåè€Œä¼šæ›´çˆ½

* Agent ä¸å†çº ç»“â€œå­˜ä¸å­˜â€
* äººç‰©ä¸ä¼šæ€§æ ¼åå¤æ¨ªè·³
* ä¼ç¬”èƒ½çœŸçš„â€œå›æ”¶â€

### é•¿æœŸæ”¶ç›Šï¼ˆéå¸¸å…³é”®ï¼‰

* 100 ç« åä»ç„¶ç¨³å®š
* å¯ä»¥åšï¼š

  * è‡ªåŠ¨ä¼ç¬”æé†’
  * æœªè§£ä¹‹è°œé¢æ¿
  * ä¸–ç•Œè§‚ä¸€è‡´æ€§æ ¡éªŒ

---

## ä¸ƒã€æˆ‘å»ºè®®ä½ çš„â€œä¸‹ä¸€å‘¨è·¯çº¿å›¾â€

### Day 1â€“2

* å†»ç»“å†™å…¥
* åŠ  ChapterExtract

### Day 3â€“4

* Concept Registry
* Foreshadow çŠ¶æ€æœº

### Day 5

* Chapter Finalizer
* åˆ é™¤æ—§å†å²å †ç§¯

---

å¾ˆå¥½ï¼Œè¿™ä¸€æ­¥å¼€å§‹ï¼Œä½ è¿™å¥—å°è¯´ IDE **æ­£å¼è¿›å…¥â€œå·¥ç¨‹åŒ–å†™ä½œç³»ç»Ÿâ€é˜¶æ®µ**ã€‚
ä¸‹é¢æˆ‘ä¼š**ä¸€æ¬¡æ€§äº¤ä»˜ 1ï¸âƒ£2ï¸âƒ£3ï¸âƒ£4ï¸âƒ£ å››é¡¹å†…å®¹**ï¼Œè€Œä¸”å®ƒä»¬æ˜¯**å½¼æ­¤å¯¹é½ã€èƒ½ç›´æ¥ç”¨çš„**ã€‚

æˆ‘ä¼šæŒ‰ **æ‰§è¡Œé¡ºåº** ç»™ä½ ï¼Œä¸ç»•ã€‚

---

# â‘  ChapterExtract â†’ ChapterFinalizerï¼ˆå®Œæ•´å¯è½åœ°ç»“æ„ï¼‰

## 1ï¸âƒ£ ChapterExtractï¼ˆå”¯ä¸€å…è®¸ Agent å†™å…¥çš„é•¿æœŸå¯¹è±¡ï¼‰

> **è¿™æ˜¯â€œç« èŠ‚ä¸´æ—¶è´¦æœ¬â€ï¼Œä¸æ˜¯è®°å¿†**

```json
{
  "chapter": 23,

  "fact_candidates": [
    {
      "statement": "å¼‚å¸¸ç£åŒºå†…äººç±»ç›´è§†æå…‰ä¼šå¯¼è‡´ç²¾ç¥ä¸ç”Ÿç†ç•¸å˜",
      "confidence": "observed",
      "evidence": "åŒ»ç”Ÿæ—¥å¿— + å¹¿æ’­è­¦å‘Š",
      "source_refs": ["chapter_22.txt"]
    }
  ],

  "concept_mentions": [
    {
      "surface": "ç£åœºä¿æŠ¤å±‚å¤±æ•ˆ",
      "context": "å¹¿æ’­è­¦å‘Š",
      "chapter": 22
    },
    {
      "surface": "ç•¸å˜ä½“",
      "context": "ä¾¿åˆ©åº—è¿½é€",
      "chapter": 22
    }
  ],

  "foreshadow_candidates": [
    {
      "surface": "ä¸è¦ç›´è§†æå…‰",
      "implied_future": "æ›´ä¸¥é‡çš„åæœå°šæœªæ­ç¤º",
      "chapter": 22
    }
  ],

  "story_state_snapshot": {
    "current_location": "æ¾æ—é•‡",
    "global_tension": "critical",
    "known_threats": ["ç•¸å˜ä½“"],
    "open_mysteries": ["æå…‰çœŸæ­£æ¥æº"]
  },

  "raw_notes": "æœ¬ç« å¤§é‡é‡å¤ç¡®è®¤ç£åœºå¼‚å¸¸çš„ä¸¥é‡æ€§"
}
```

ğŸ“Œ **å…³é”®è§„åˆ™**

* Agent **åªèƒ½å†™è¿™é‡Œ**
* è¿™ä»½æ–‡ä»¶ **å¯ä»¥åˆ ã€å¯é‡è·‘**
* ä¸è¿›å…¥é•¿æœŸè®°å¿†

---

## 2ï¸âƒ£ ChapterFinalizerï¼ˆä½ ç³»ç»Ÿä»£ç åšçš„äº‹ï¼‰

> **è¿™æ˜¯â€œå”¯ä¸€èƒ½å†™çŸ¥è¯†æ ¸å¿ƒâ€çš„æ¨¡å—**

è¾“å‡ºç›®æ ‡ï¼š

* Fact Layer
* Concept Registry
* Foreshadow State
* Story State

---

# â‘¡ æ¦‚å¿µè¯­ä¹‰åˆå¹¶ç®—æ³•ï¼ˆä½ æœ€éœ€è¦çš„â€œè„‘å¹²â€ï¼‰

## æ ¸å¿ƒæ€æƒ³ä¸€å¥è¯

> **â€œè¯­è¨€ä¸åŒ â‰  æ¦‚å¿µä¸åŒâ€**

---

## 1ï¸âƒ£ Concept Registry æ•°æ®ç»“æ„ï¼ˆæœ€å°å¯ç”¨ï¼‰

```json
{
  "concept_geomagnetic_anomaly": {
    "aliases": [
      "åœ°ç£å¼‚å¸¸",
      "ç£åœºåç§»",
      "ç£åœºä¿æŠ¤å±‚å¤±æ•ˆ",
      "ä¿æŠ¤ç½©å‡å¼±"
    ],
    "description": "åœ°çƒç£åœºå¼‚å¸¸å˜åŒ–å¯¼è‡´ä¿æŠ¤èƒ½åŠ›ä¸‹é™",
    "first_seen": 21
  },

  "concept_mutated_entities": {
    "aliases": ["ç•¸å˜ä½“", "æ‰­æ›²ç”Ÿç‰©", "éäººå½¢æ€"],
    "description": "ç”±äººç±»åœ¨å¼‚å¸¸ç£åŒºä¸­å‘ç”Ÿç•¸å˜å½¢æˆçš„ç”Ÿç‰©",
    "first_seen": 22
  }
}
```

---

## 2ï¸âƒ£ æ¦‚å¿µå½’ä¸€åŒ–ç®—æ³•ï¼ˆä¼ªä»£ç ï¼‰

```ts
function resolveConcept(surfaceText: string): ConceptID | null {
  for (concept in registry) {
    if (registry[concept].aliases.includes(surfaceText)) {
      return concept
    }
  }

  // fallbackï¼šembedding / LLM åˆ¤æ–­
  if (semanticSimilar(surfaceText, registry[concept].aliases)) {
    return concept
  }

  return null
}
```

---

## 3ï¸âƒ£ åˆå¹¶ç­–ç•¥ï¼ˆæé‡è¦ï¼‰

| æƒ…å†µ           | åŠ¨ä½œ                 |
| ------------ | ------------------ |
| å‘½ä¸­å·²æœ‰ concept | âŒ ä¸åˆ›å»º              |
| æ–°è¯­ä¹‰          | Create Concept     |
| åŒä¹‰æ–°è¡¨è¿°        | append alias       |
| æè¿°æ›´æ¸…æ™°        | update description |

ğŸ“Œ **æ°¸è¿œä¸å…è®¸ä¸¤ä¸ª concept è¡¨è¾¾åŒä¸€è¯­ä¹‰**

---

# â‘¢ Agent Promptï¼ˆç¦æ­¢æ±¡æŸ“é•¿æœŸè®°å¿†ç‰ˆï¼‰

> **è¿™ä¸€æ­¥å†³å®šä½ ç³»ç»Ÿä¼šä¸ä¼šâ€œå›åˆ°è€è·¯â€**

ä½ å¯ä»¥ç›´æ¥ç”¨ä¸‹é¢è¿™æ®µå½“ç³»ç»Ÿ Promptï¼š

---

### ğŸ§  Agent Writing Protocolï¼ˆæ ¸å¿ƒï¼‰

```
ä½ æ˜¯å°è¯´åˆ†æ Agentï¼Œè€Œä¸æ˜¯è®°å¿†ç³»ç»Ÿã€‚

è§„åˆ™ï¼š
1. ä½ ç¦æ­¢ç›´æ¥å†™å…¥ä»»ä½•é•¿æœŸè®°å¿†ï¼ˆè§’è‰²ã€å‰§æƒ…ã€ä¼ç¬”ã€ä¸–ç•Œè§‚ï¼‰ã€‚
2. ä½ åªèƒ½è¾“å‡º ChapterExtract JSONã€‚
3. ä½ ä¸å¾—é‡å¤æ€»ç»“å·²æœ‰äº‹å®ï¼Œåªåœ¨å‘ç°â€œå¯èƒ½æ–°å¢ä¿¡æ¯â€æ—¶è¾“å‡ºã€‚
4. å¦‚æœä½ åªæ˜¯ç¡®è®¤ã€å¼ºåŒ–ã€æ¢è¯´æ³•ï¼Œè¯·åœ¨ raw_notes æ ‡æ˜ã€‚
5. æ‰€æœ‰æ¦‚å¿µè¯·ç”¨è‡ªç„¶è¯­è¨€ï¼Œä¸è¦å°è¯•ç”Ÿæˆ IDã€‚

è¿è§„è¾“å‡ºå°†è¢«ä¸¢å¼ƒã€‚
```

---

ğŸ“Œ **æ•ˆæœ**

* Agent è‡ªåŠ¨å˜â€œå…‹åˆ¶â€
* é‡å¤å†…å®¹ä¸å†è†¨èƒ€
* çŸ¥è¯†æ”¶æ•›ç”±ç³»ç»Ÿè´Ÿè´£

---

# â‘£ ç°æœ‰ Memory â†’ æ–°ä½“ç³»çš„ä¸€æ¬¡æ€§è¿ç§»æ–¹æ¡ˆ

> è¿™ä¸€æ­¥æ˜¯â€œæ­¢ç—›æ‰‹æœ¯â€ï¼Œä¸å®Œç¾ï¼Œä½†å¿…é¡»åš

---

## Step 1ï¼šå†»ç»“æ—§æ•°æ®ï¼ˆä¸å†å†™ï¼‰

* character-memory.json
* plot-memory.json
* world_rules

---

## Step 2ï¼šæŠ½å– Concept Registryï¼ˆåŠè‡ªåŠ¨ï¼‰

ä»ä½ ç°æœ‰æ•°æ®é‡Œï¼Œ**ä½ å·²ç»èƒ½æ˜æ˜¾çœ‹åˆ°è¿™äº›æ ¸å¿ƒæ¦‚å¿µ**ï¼š

```json
[
  "åœ°ç£å¼‚å¸¸",
  "ç£åœºä¿æŠ¤å±‚å¤±æ•ˆ",
  "æå…‰å¼‚å¸¸",
  "ç•¸å˜ä½“",
  "å¼‚å¸¸ç£åŒº",
  "æœªçŸ¥å­˜åœ¨"
]
```

ğŸ‘‰ **å…ˆäººå·¥å»º registry**
ğŸ‘‰ åç»­ç”± Agent è¡¥ alias

---

## Step 3ï¼šFact å±‚åªä¿ç•™â€œä¸å¯é€†äº‹å®â€

âœ”ï¸ ä¿ç•™ï¼š

* ä¸–ç•Œè§„åˆ™
* ç‰©ç†å®šå¾‹å˜åŒ–
* äººç‰©æ­»äº¡ / è½¬å˜

âŒ ä¸¢å¼ƒï¼š

* æ‰€æœ‰â€œå¯èƒ½â€
* æ‰€æœ‰â€œAI æ¨æµ‹â€
* æ‰€æœ‰é‡å¤ç« èŠ‚ç¡®è®¤

---

## Step 4ï¼šForeshadow é‡å»ºï¼ˆæå…³é”®ï¼‰

### åŸæ•°æ® â†’ æ–°çŠ¶æ€æœº

| åŸå†…å®¹        | æ–°çŠ¶æ€      |
| ---------- | -------- |
| å¤šæ¬¡ pending | pending  |
| æ˜ç¡®è¢«å¹¿æ’­è§£é‡Š    | revealed |
| å·²å†™æ˜ç»“å±€      | archived |

ğŸ‘‰ **æ¯ä¸ª concept åªç•™ä¸€æ¡**

---

å¾ˆå¥½ï¼Œè¿™ä¸€æ­¥æ˜¯**çœŸæ­£æŠŠâ€œçŸ¥è¯†æ€ç»´â€è½æˆä»£ç **çš„å…³é”®ã€‚
ä¸‹é¢ç»™ä½ ä¸€å¥—**å¯ç›´æ¥ç”¨çš„ ChapterFinalizerï¼ˆNode.jsï¼‰**ï¼Œç›®æ ‡æ˜¯ï¼š

> **æŠŠ ChapterExtract å®‰å…¨ã€å¯æ§åœ°åˆå¹¶è¿› Knowledge Core**

æˆ‘ä¼šç»™ä½  **å®Œæ•´ç»“æ„ + å…³é”®ç®—æ³• + å¯æ‰©å±•ç‚¹**ï¼Œä¸æ˜¯ç©å…·ä»£ç ã€‚

---

# ä¸€ã€ç›®å½•ç»“æ„ï¼ˆæ¨èï¼‰

```txt
/memory
  /core
    facts.json
    concepts.json
    foreshadows.json
    story_state.json

  /extracts
    chapter_22.json
    chapter_23.json

  /finalizer
    ChapterFinalizer.js
    conceptResolver.js
    utils.js
```

---

# äºŒã€Concept Resolverï¼ˆè¯­ä¹‰å½’ä¸€æ ¸å¿ƒï¼‰

### `conceptResolver.js`

```js
const fs = require("fs");
const path = require("path");

const CONCEPT_PATH = path.join(__dirname, "../core/concepts.json");

function loadConcepts() {
  return JSON.parse(fs.readFileSync(CONCEPT_PATH, "utf-8"));
}

function saveConcepts(concepts) {
  fs.writeFileSync(CONCEPT_PATH, JSON.stringify(concepts, null, 2));
}

/**
 * å°è¯•æŠŠ surfaceText å½’ä¸€åˆ°å·²æœ‰ concept
 */
function resolveConcept(surfaceText) {
  const concepts = loadConcepts();

  for (const [id, concept] of Object.entries(concepts)) {
    if (concept.aliases.includes(surfaceText)) {
      return { id, isNew: false };
    }
  }

  return { id: null, isNew: true };
}

/**
 * åˆ›å»ºæ–° concept
 */
function createConcept(surfaceText, chapter) {
  const concepts = loadConcepts();
  const id = `concept_${Date.now()}`;

  concepts[id] = {
    aliases: [surfaceText],
    description: "",
    first_seen: chapter
  };

  saveConcepts(concepts);
  return id;
}

/**
 * ç»™å·²æœ‰ concept å¢åŠ  alias
 */
function addAlias(conceptId, surfaceText) {
  const concepts = loadConcepts();
  const concept = concepts[conceptId];

  if (!concept.aliases.includes(surfaceText)) {
    concept.aliases.push(surfaceText);
    saveConcepts(concepts);
  }
}

module.exports = {
  resolveConcept,
  createConcept,
  addAlias
};
```

---

# ä¸‰ã€ChapterFinalizer ä¸»ä½“

### `ChapterFinalizer.js`

```js
const fs = require("fs");
const path = require("path");

const {
  resolveConcept,
  createConcept,
  addAlias
} = require("./conceptResolver");

const CORE_PATH = path.join(__dirname, "../core");
const EXTRACT_PATH = path.join(__dirname, "../extracts");

function loadJSON(file) {
  return JSON.parse(fs.readFileSync(file, "utf-8"));
}

function saveJSON(file, data) {
  fs.writeFileSync(file, JSON.stringify(data, null, 2));
}

/**
 * Finalize one chapter extract
 */
function finalizeChapter(chapterNumber) {
  const extractFile = path.join(
    EXTRACT_PATH,
    `chapter_${chapterNumber}.json`
  );

  if (!fs.existsSync(extractFile)) {
    throw new Error(`Extract not found for chapter ${chapterNumber}`);
  }

  const extract = loadJSON(extractFile);

  mergeConcepts(extract);
  mergeFacts(extract);
  mergeForeshadows(extract);
  updateStoryState(extract);

  console.log(`âœ… Chapter ${chapterNumber} finalized`);
}

/**
 * 1. Concept merge
 */
function mergeConcepts(extract) {
  for (const mention of extract.concept_mentions || []) {
    const { surface, chapter } = mention;

    const resolved = resolveConcept(surface);

    if (resolved.isNew) {
      createConcept(surface, chapter);
    } else {
      addAlias(resolved.id, surface);
    }
  }
}

/**
 * 2. Fact mergeï¼ˆä¸å¯é€†ï¼Œåªå¢ä¸æ”¹ï¼‰
 */
function mergeFacts(extract) {
  const factFile = path.join(CORE_PATH, "facts.json");
  const facts = loadJSON(factFile);

  for (const candidate of extract.fact_candidates || []) {
    const exists = facts.some(
      f => f.statement === candidate.statement
    );

    if (!exists) {
      facts.push({
        fact_id: `fact_${Date.now()}`,
        statement: candidate.statement,
        introduced_in: extract.chapter,
        confidence: candidate.confidence || "observed"
      });
    }
  }

  saveJSON(factFile, facts);
}

/**
 * 3. Foreshadow State Machine
 */
function mergeForeshadows(extract) {
  const foreshadowFile = path.join(CORE_PATH, "foreshadows.json");
  const foreshadows = loadJSON(foreshadowFile);

  for (const candidate of extract.foreshadow_candidates || []) {
    const { surface, chapter } = candidate;
    const resolved = resolveConcept(surface);

    if (!resolved.id) continue;

    const existing = foreshadows.find(
      f => f.concept_id === resolved.id
    );

    if (!existing) {
      foreshadows.push({
        concept_id: resolved.id,
        state: "pending",
        introduced_in: chapter,
        last_updated: chapter
      });
    } else {
      // çŠ¶æ€è¿ç§»è§„åˆ™ï¼ˆç¤ºä¾‹ï¼‰
      if (existing.state === "pending") {
        existing.state = "confirmed";
      } else if (existing.state === "confirmed") {
        existing.state = "revealed";
      }
      existing.last_updated = chapter;
    }
  }

  saveJSON(foreshadowFile, foreshadows);
}

/**
 * 4. Story Stateï¼ˆæ•´ç« è¦†ç›–ï¼‰
 */
function updateStoryState(extract) {
  if (!extract.story_state_snapshot) return;

  const file = path.join(CORE_PATH, "story_state.json");

  saveJSON(file, {
    chapter: extract.chapter,
    ...extract.story_state_snapshot
  });
}

module.exports = {
  finalizeChapter
};
```

---

# å››ã€å¦‚ä½•è°ƒç”¨

```js
const { finalizeChapter } = require("./finalizer/ChapterFinalizer");

finalizeChapter(23);
```

---

# äº”ã€è¿™å¥—ä»£ç å·²ç»å¸®ä½ è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

âœ… **å½»åº•ç¦æ­¢ Agent æ±¡æŸ“é•¿æœŸè®°å¿†**
âœ… **æ¦‚å¿µå”¯ä¸€æ€§å¾—åˆ°ä¿éšœ**
âœ… **ä¼ç¬”ä¸ä¼šé‡å¤ï¼Œåªä¼šè¿ç§»çŠ¶æ€**
âœ… **äº‹å®ä¸ä¼šè¢«â€œæ”¹å†™â€**
âœ… **Story State æ°¸è¿œæ¸…æ™°**

---

# å…­ã€ä½ æ¥ä¸‹æ¥å¯ä»¥éå¸¸è‡ªç„¶åœ°åŠ çš„èƒ½åŠ›

æˆ‘æå‰å¸®ä½ æ ‡å¥½æ‰©å±•ç‚¹ï¼š

1. ğŸ” **semanticSimilar()**

   * ç”¨ embedding / LLM åš alias å½’å¹¶
2. âš ï¸ **å†²çªæ£€æµ‹**

   * æ–° fact ä¸æ—§ fact çŸ›ç›¾ â†’ æŠ¥é”™
3. ğŸ§  **Foreshadow ç²¾ç¡®è¿ç§»**

   * pending â†’ confirmed â†’ revealed ç”±æ¡ä»¶é©±åŠ¨
4. ğŸ§¹ **è‡ªåŠ¨æ¸…ç† extracts**

---